# WhatsApp API Configuration - Backend Requirements

This document outlines the backend requirements for managing WhatsApp Business API configuration settings.

## Overview

The system needs to store and manage credentials required to communicate with the WhatsApp Business Cloud API. These settings are tenant-specific (or global for a single-user system).

## Data Structures

### WhatsAppConfig
Stores the credentials and settings for the WhatsApp Business API integration.

```typescript
interface WhatsAppConfig {
  id: string;
  phoneNumberId: string;      // The Phone Number ID from Meta App Dashboard
  businessAccountId: string;  // The WhatsApp Business Account ID
  accessToken: string;        // System User Access Token (Permanent)
  webhookVerifyToken: string; // Custom token for webhook verification
  webhookUrl: string;         // The callback URL (read-only, generated by backend)
  apiVersion: string;         // e.g., "v17.0"
  updatedAt: string;
}
```

## API Endpoints

### 1. Get Configuration
Retrieve the current WhatsApp API configuration. Sensitive fields like `accessToken` might be masked or returned partially.

- **Endpoint**: `GET /api/settings/whatsapp`
- **Response**: `WhatsAppConfig`

### 2. Update Configuration
Save or update the WhatsApp API configuration.

- **Endpoint**: `PUT /api/settings/whatsapp`
- **Body**:
  ```json
  {
    "phoneNumberId": "123456789",
    "businessAccountId": "987654321",
    "accessToken": "EAAG...",
    "webhookVerifyToken": "my_secure_token",
    "apiVersion": "v18.0"
  }
  ```
- **Response**: `WhatsAppConfig`
- **Validation**:
  - `phoneNumberId`: Required, numeric string.
  - `businessAccountId`: Required, numeric string.
  - `accessToken`: Required, string.
  - `webhookVerifyToken`: Required, string (min 8 chars recommended).

### 3. Test Connection
Optional endpoint to verify if the credentials are valid by making a test call to Meta Graph API (e.g., fetching phone number details).

- **Endpoint**: `POST /api/settings/whatsapp/test`
- **Body**: (Empty, uses stored config) or pass config in body to test before saving.
- **Response**: 
  ```json
  {
    "success": true,
    "message": "Connection successful. Phone number: +1 555 0123"
  }
  ```
  OR
  ```json
  {
    "success": false,
    "error": "Invalid Access Token"
  }
  ```

## Webhook Requirements

### 1. Verification Endpoint
Handle the webhook verification challenge from Meta.

- **Endpoint**: `GET /api/webhooks/whatsapp`
- **Query Params**:
  - `hub.mode`: "subscribe"
  - `hub.verify_token`: Must match `WhatsAppConfig.webhookVerifyToken`
  - `hub.challenge`: Random string to echo back
- **Behavior**:
  - Verify `hub.verify_token` matches stored token.
  - Return `hub.challenge` as plain text with 200 OK.

### 2. Event Notification Endpoint
Receive incoming messages and status updates.

- **Endpoint**: `POST /api/webhooks/whatsapp`
- **Body**: JSON payload from Meta (messages, statuses, etc.)
- **Behavior**:
  - Verify `X-Hub-Signature` (optional but recommended security).
  - Process incoming messages (store in DB, emit via WebSocket).
  - Return 200 OK immediately.
